<!DOCTYPE html>
<!-- saved from url=(0052)http://westonruter.github.io/html5-audio-read-along/ -->
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>humannature_01_hume_64kb - 听语族</title>
        <meta name="viewport" content="width=device-width" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<style>
html {
    background: #333;
    font-family: Verdana, sans-serif;
}
body {
    padding: 0;
    margin: 5px;
}
article {
    background: white;
    border-radius: 1em;
    margin-top: 130px;
    padding: 1em;
}
a {
    color: #0E2560;
}
h1 {
    font-size: 14pt;
    white-space: nowrap;
    word-wrap: keep-all;
}
h2 {
    margin-bottom: 1em;
}
#passage-text.speaking {
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

q {
    quotes: "“" "”" "‘" "’";
}
.section-heading {
    display: none;
}
.passage p {
    line-height: 1.4em;
}
.verse-start {
    line-height: 0;
}
.initialized span[data-begin]:focus,
.initialized span[data-begin]:hover {
    background-color: #FFFFCA;
    box-shadow: 0px 0px 4px #FFFFCA;
}
.initialized span[data-begin].speaking {
    background-color: yellow;
    box-shadow: 0px 0px 4px yellow;
}
.initialized span[data-begin] {
    cursor: pointer;
}
.initialized span.nomatch {
    background-color: lightgray;
    color: purple;
}
.error {
    color: red;
}

article > footer {
    border-top: solid 1px gray;
    padding-top: 1em;
    margin-top: 1em;
}

footer {
    margin-bottom: 0.5em;
    line-height: 1.4em;
    font-size: small;
}
footer img {
    vertical-align: text-bottom;
}

header {
    width: 100%;
    color: #cce;
    background-color: #333;
    position: fixed;
    top: 0;
    left: 0;
    overflow: hidden;
    -moz-transition: all 0.5s ease;
    -o-transition: all 0.5s ease;
    -webkit-transition: all 0.5s ease;
    transition: all 0.5s ease;
    text-align: center;
}
header h1 {
    color: #cce;
    -moz-transition: all 0.3s ease;
    -o-transition: all 0.3s ease;
    -webkit-transition: all 0.3s ease;
    transition: all 0.3s ease;
}
header .passage-audio {
    width: 100%;
    text-align: center;
}
header .passage-audio #passage-audio {
    width: 100%;
}
header .passage-control {
    display: block;
    width: 520px;
    height: 40px;
    margin: 5px auto 0 auto;
}
header .playback-rate {
    height: 40px;
    padding: 0px 0px 0px 6px;
    display: block;
    float: left;
}
header .autofocus-current-word {
    height: 40px;
    padding: 0px 0px 0px 6px;
    display: block;
    float: left;
}
header .playback-rate label,
header .playback-rate output,
header .autofocus-current-word label,
header .autofocus-current-word input {
    vertical-align: middle;
    font-size: smaller;
    font-weight: bold;
}

body.sticky-header {
    padding-top: 10px;
}
body.sticky-header header {
    background-color: rgba(127, 127, 127, 0.9);
}
body.sticky-header header h1 {
    display: none;
}
body.sticky-header header .passage-audio {
    padding-top: 5px;
    padding-bottom: 5px;
}
body.sticky-header header .passage-control {
    width: 240px;
}
body.sticky-header header .playback-rate {
}
body.sticky-header header .playback-rate label,
body.sticky-header header .playback-rate output {
    display: none;
}
body.sticky-header header .autofocus-current-word {
}
body.sticky-header header .autofocus-current-word label {
    display: none;
}

input[type=range] {
    -webkit-appearance: none;
    width: 130px;
    border-radius: 10px;
}
input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
}
input[type=range]::-webkit-slider-runnable-track {
    width: 130px;
    height: 15px;
    cursor: pointer;
    animate: 0.2s;
    box-shadow: 0 1px 1px #def3f8, inset 0 .125em .125em #0d1112; /*轨道内置阴影效果*/
    border-radius: 10px; /*将轨道设为圆角的*/
}
input[type=range]:focus {
    outline: none;
}
input[type=range]::-ms-track {
    width: 130px;
    cursor: pointer;
    background: transparent;;
    border-color: transparent; /*去除原有边框*/
    color: transparent; /*去除轨道内的竖线*/
}
input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 25px;
    width: 25px;
    margin-top: -5px; /*使滑块超出轨道部分的偏移量相等*/
    background: #ffffff;
    border-radius: 50%; /*外观设置为圆形*/
    border: solid 0.125em rgba(205, 224, 230, 0.5); /*设置边框*/
    box-shadow: 0 .125em .125em #3b4547; /*添加底部阴影*/
}
input[type=range]::-moz-range-progress {
    background: linear-gradient(to right, #059CFA, white 100%, white);
    height: 13px;
    border-radius: 10px;
}
input[type=range]::-ms-track {
    height: 25px;
    border-radius: 10px;
    box-shadow: 0 1px 1px #def3f8, inset 0 .125em .125em #0d1112;
    border-color: transparent; /*去除原有边框*/
    color: transparent; /*去除轨道内的竖线*/
}
input[type=range]::-ms-thumb {
    border: solid 0.125em rgba(205, 224, 230, 0.5);
    height: 25px;
    width: 25px;
    border-radius: 50%;
    background: #ffffff;
    margin-top: -5px;
    box-shadow: 0 .125em .125em #3b4547;
}
input[type=range]::-ms-fill-lower {
    /*进度条已填充的部分*/
    height: 22px;
    border-radius: 10px;
    background: linear-gradient(to right, #059CFA, white 100%, white);
}
input[type=range]::-ms-fill-upper {
    /*进度条未填充的部分*/
    height: 22px;
    border-radius: 10px;
    background: #ffffff;
}
input[type=range]:focus::-ms-fill-lower {
    background: linear-gradient(to right, #059CFA, white 100%, white);
}
input[type=range]:focus::-ms-fill-upper {
    background: #ffffff;
}

.mui-switch {
    width: 58px;
    height: 15px;
    position: relative;
    border: 1px solid #dfdfdf;
    background-color: #fdfdfd;
    box-shadow: #dfdfdf 0 0 0 0 inset;
    border-radius: 20px;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    background-clip: content-box;
    display: inline-block;
    -webkit-appearance: none;
    user-select: none;
    outline: none;
}
.mui-switch:before {
    content: '';
    width: 26px;
    height: 26px;
    position: absolute;
    top: -6px;
    left: 0;
    border-radius: 20px;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    background-color: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
}
.mui-switch:checked {
    border-color: #64bd63;
    box-shadow: #64bd63 0 0 0 16px inset;
    background-color: #64bd63;
}
.mui-switch:checked:before {
    left: 31px;
}
.mui-switch.mui-switch-animbg {
    transition: background-color ease 0.4s;
}
.mui-switch.mui-switch-animbg:before {
    transition: left 0.3s;
}
.mui-switch.mui-switch-animbg:checked {
    box-shadow: #dfdfdf 0 0 0 0 inset;
    background-color: #64bd63;
    transition: border-color 0.4s, background-color ease 0.4s;
}
.mui-switch.mui-switch-animbg:checked:before {
    transition: left 0.3s;
}
.mui-switch.mui-switch-anim {
    transition: border cubic-bezier(0, 0, 0, 1) 0.4s, box-shadow cubic-bezier(0, 0, 0, 1) 0.4s;
}
.mui-switch.mui-switch-anim:before {
    transition: left 0.3s;
}
.mui-switch.mui-switch-anim:checked {
    box-shadow: #64bd63 0 0 0 16px inset;
    background-color: #64bd63;
    transition: border ease 0.4s, box-shadow ease 0.4s, background-color ease 1.2s;
}
.mui-switch.mui-switch-anim:checked:before {
    transition: left 0.3s;
}
</style>
    </head>
    <body class="initialized">

        <header>
            <h1>听语族: humannature_01_hume_64kb</h1>

            <div class="passage-audio">
                <audio id="passage-audio" controls="">
                    <!-- @todo WebM? -->
                    <source src="humannature_01_hume_64kb.mp3" type="audio/mp3">
                    <em class="error"><strong>Error:</strong> Your browser doesn't appear to support HTML5 Audio.</em>
                </audio>
            </div>

            <div class="passage-control">
                <div class="playback-rate" title="Note that increaseing the reading rate will decrease accuracy of word highlights">
                    <label for="playback-rate">语速:</label>
                    <input id="playback-rate" type="range" min="0.5" max="2.0" value="1.0" step="0.1" onchange="document.querySelector('#playback-rate-curr').innerText = 'x' + String(Math.round(this.valueAsNumber * 10) / 10);">
                    <label id="playback-rate-curr">x1</label>
                </div>
                <div class="autofocus-current-word">
                    <label for="autofocus-current-word">跟随:</label>
                    <input id="autofocus-current-word" class="mui-switch mui-switch-animbg" type="checkbox" checked="checked">
                </div>
            </div>

        </header>

        <article>

            <div class="notice">
                <p class="loading" hidden="">
                    <em> Loading </em>audio
                </p>

                <p class="passage-audio-unavailable" hidden="">
                    <em class="error"><strong>Error:</strong> You will not be able to do the read-along audio because your browser is not able to play MP3, Ogg, or WAV audio formats.</em>
                </p>

                <p class="playback-rate-unavailable" hidden="">
                    <em>(It seems your browser does not support <code>HTMLMediaElement.playbackRate</code>, so you will not be able to change the speech rate.)</em>
                </p>

                <noscript>
                    &lt;p class="error"&gt;&lt;em&gt;&lt;strong&gt;Notice:&lt;/strong&gt; You must have JavaScript enabled/available to try this HTML5 Audio read along.&lt;/em&gt;&lt;/p&gt;
                </noscript>
            </div>

            <div id="passage-text" class="passage">
<p> <span data-index="1" data-begin="15.979" data-dur="0.789" tabindex="0">ADVERTISEMENT</span>   .</p>
<p> <span data-index="2" data-begin="18.809" data-dur="0.149" tabindex="0">My</span>   <span data-index="3" data-begin="18.959" data-dur="0.57" tabindex="0">design</span>   <span data-index="4" data-begin="19.529" data-dur="0.269" tabindex="0">in</span>   <span data-index="5" data-begin="19.8" data-dur="0.089" tabindex="0">the</span>   <span data-index="6" data-begin="19.889" data-dur="0.37" tabindex="0">present</span>   <span data-index="7" data-begin="20.289" data-dur="0.37" tabindex="0">work</span>   <span data-index="8" data-begin="21.05" data-dur="0.14" tabindex="0">is</span>   <span data-index="9" data-begin="21.189" data-dur="0.65" tabindex="0">sufficiently</span>   <span data-index="10" data-begin="21.839" data-dur="0.659" tabindex="0">explained</span>   <span data-index="11" data-begin="22.53" data-dur="0.199" tabindex="0">in</span>   <span data-index="12" data-begin="22.729" data-dur="0.099" tabindex="0">the</span>   <span data-index="13" data-begin="22.829" data-dur="0.71" tabindex="0">Introduction</span>   .  <span data-index="14" data-begin="24.939" data-dur="0.099" tabindex="0">The</span>   <span data-index="15" data-begin="25.039" data-dur="0.29" tabindex="0">reader</span>   <span data-index="16" data-begin="25.329" data-dur="0.29" tabindex="0">must</span>   <span data-index="17" data-begin="25.649" data-dur="0.34" tabindex="0">only</span>   <span data-index="18" data-begin="25.989" data-dur="0.42" tabindex="0">observe</span>   ,  <span data-index="19" data-begin="26.789" data-dur="0.14" tabindex="0">that</span>   <span data-index="20" data-begin="26.959" data-dur="0.22" tabindex="0">all</span>   <span data-index="21" data-begin="27.18" data-dur="0.089" tabindex="0">the</span>   <span data-index="22" data-begin="27.269" data-dur="0.63" tabindex="0">subjects</span>   <span data-index="23" data-begin="27.939" data-dur="0.199" tabindex="0">I</span>   <span data-index="24" data-begin="28.14" data-dur="0.179" tabindex="0">have</span>   <span data-index="25" data-begin="28.349" data-dur="0.299" tabindex="0">there</span>   <span data-index="26" data-begin="28.649" data-dur="0.41" tabindex="0">planned</span>   <span data-index="27" data-begin="29.059" data-dur="0.19" tabindex="0">out</span>   <span data-index="28" data-begin="29.3" data-dur="0.13" tabindex="0">to</span>   <span data-index="29" data-begin="29.43" data-dur="0.64" tabindex="0">myself</span>   ,  <span data-index="30" data-begin="30.479" data-dur="0.14" tabindex="0">are</span>   <span data-index="31" data-begin="30.619" data-dur="0.37" tabindex="0">not</span>   <span data-index="32" data-begin="31.029" data-dur="0.429" tabindex="0">treated</span>   <span data-index="33" data-begin="31.57" data-dur="0.199" tabindex="0">of</span>   <span data-index="34" data-begin="32.099" data-dur="0.179" tabindex="0">in</span>   <span data-index="35" data-begin="32.279" data-dur="0.269" tabindex="0">these</span>   <span data-index="36" data-begin="32.55" data-dur="0.179" tabindex="0">two</span>   <span data-index="37" data-begin="32.789" data-dur="0.669" tabindex="0">volumes</span>   .  <span data-index="38" data-begin="34.48" data-dur="0.099" tabindex="0">The</span>   <span data-index="39" data-begin="34.579" data-dur="0.56" tabindex="0">subjects</span>   <span data-index="40" data-begin="35.169" data-dur="0.21" tabindex="0">of</span>   <span data-index="41" data-begin="35.379" data-dur="0.149" tabindex="0">the</span>   <span data-index="42" data-begin="35.529" data-dur="0.789" tabindex="0">Understanding</span>   <span data-index="43" data-begin="36.32" data-dur="0.17" tabindex="0">and</span>   <span data-index="44" data-begin="36.489" data-dur="0.729" tabindex="0">Passions</span>   <span data-index="45" data-begin="37.619" data-dur="0.24" tabindex="0">make</span>   <span data-index="46" data-begin="37.859" data-dur="0.06" tabindex="0">a</span>   <span data-index="47" data-begin="37.919" data-dur="0.459" tabindex="0">compleat</span>   <span data-index="48" data-begin="38.379" data-dur="0.37" tabindex="0">chain</span>   <span data-index="49" data-begin="38.749" data-dur="0.11" tabindex="0">of</span>   <span data-index="50" data-begin="38.859" data-dur="0.48" tabindex="0">reasoning</span>   <span data-index="51" data-begin="39.339" data-dur="0.26" tabindex="0">by</span>   <span data-index="52" data-begin="39.629" data-dur="0.81" tabindex="0">themselves</span>   ;  <span data-index="53" data-begin="40.789" data-dur="0.22" tabindex="0">and</span>   <span data-index="54" data-begin="41.009" data-dur="0.12" tabindex="0">I</span>   <span data-index="55" data-begin="41.129" data-dur="0.24" tabindex="0">was</span>   <span data-index="56" data-begin="41.37" data-dur="0.34" tabindex="0">willing</span>   <span data-index="57" data-begin="41.709" data-dur="0.12" tabindex="0">to</span>   <span data-index="58" data-begin="41.829" data-dur="0.25" tabindex="0">take</span>   <span data-index="59" data-begin="42.079" data-dur="0.599" tabindex="0">advantage</span>   <span data-index="60" data-begin="42.71" data-dur="0.19" tabindex="0">of</span>   <span data-index="61" data-begin="42.899" data-dur="0.22" tabindex="0">this</span>   <span data-index="62" data-begin="43.12" data-dur="0.41" tabindex="0">natural</span>   <span data-index="63" data-begin="43.559" data-dur="0.53" tabindex="0">division</span>   ,  <span data-index="64" data-begin="44.589" data-dur="0.179" tabindex="0">in</span>   <span data-index="65" data-begin="44.769" data-dur="0.269" tabindex="0">order</span>   <span data-index="66" data-begin="45.04" data-dur="0.19" tabindex="0">to</span>   <span data-index="67" data-begin="45.229" data-dur="0.52" tabindex="0">try</span>   <span data-index="68" data-begin="45.779" data-dur="0.07" tabindex="0">the</span>   <span data-index="69" data-begin="45.849" data-dur="0.45" tabindex="0">taste</span>   <span data-index="70" data-begin="46.299" data-dur="0.19" tabindex="0">of</span>   <span data-index="71" data-begin="46.489" data-dur="0.07" tabindex="0">the</span>   <span data-index="72" data-begin="46.559" data-dur="0.51" tabindex="0">public</span>   .  <span data-index="73" data-begin="48.399" data-dur="0.199" tabindex="0">If</span>   <span data-index="74" data-begin="48.599" data-dur="0.149" tabindex="0">I</span>   <span data-index="75" data-begin="48.749" data-dur="0.229" tabindex="0">have</span>   <span data-index="76" data-begin="48.979" data-dur="0.07" tabindex="0">the</span>   <span data-index="77" data-begin="49.049" data-dur="0.25" tabindex="0">good</span>   <span data-index="78" data-begin="49.299" data-dur="0.429" tabindex="0">fortune</span>   <span data-index="79" data-begin="49.729" data-dur="0.12" tabindex="0">to</span>   <span data-index="80" data-begin="49.849" data-dur="0.25" tabindex="0">meet</span>   <span data-index="81" data-begin="50.129" data-dur="0.13" tabindex="0">with</span>   <span data-index="82" data-begin="50.259" data-dur="0.69" tabindex="0">success</span>   ,  <span data-index="83" data-begin="51.329" data-dur="0.13" tabindex="0">I</span>   <span data-index="84" data-begin="51.459" data-dur="0.24" tabindex="0">shall</span>   <span data-index="85" data-begin="51.699" data-dur="0.5" tabindex="0">proceed</span>   <span data-index="86" data-begin="52.199" data-dur="0.149" tabindex="0">to</span>   <span data-index="87" data-begin="52.349" data-dur="0.12" tabindex="0">the</span>   <span data-index="88" data-begin="52.469" data-dur="0.84" tabindex="0">examination</span>   <span data-index="89" data-begin="53.309" data-dur="0.17" tabindex="0">of</span>   <span data-index="90" data-begin="53.479" data-dur="0.64" tabindex="0">Morals</span>   ,  <span data-index="91" data-begin="54.419" data-dur="0.729" tabindex="0">Politics</span>   ,  <span data-index="92" data-begin="55.45" data-dur="0.17" tabindex="0">and</span>   <span data-index="93" data-begin="55.619" data-dur="0.719" tabindex="0">Criticism</span>   ;  <span data-index="94" data-begin="56.869" data-dur="0.24" tabindex="0">which</span>   <span data-index="95" data-begin="57.11" data-dur="0.12" tabindex="0">will</span>   <span data-index="96" data-begin="57.229" data-dur="0.599" tabindex="0">compleat</span>   <span data-index="97" data-begin="58.169" data-dur="0.19" tabindex="0">this</span>   <span data-index="98" data-begin="58.36" data-dur="0.5" tabindex="0">Treatise</span>   <span data-index="99" data-begin="58.86" data-dur="0.14" tabindex="0">of</span>   <span data-index="100" data-begin="59.07" data-dur="0.269" tabindex="0">Human</span>   <span data-index="101" data-begin="59.339" data-dur="0.399" tabindex="0">Nature</span>   .  <span data-index="102" data-begin="60.9" data-dur="0.17" tabindex="0">The</span>   <span data-index="103" data-begin="61.07" data-dur="0.71" tabindex="0">approbation</span>   <span data-index="104" data-begin="61.779" data-dur="0.17" tabindex="0">of</span>   <span data-index="105" data-begin="61.949" data-dur="0.08" tabindex="0">the</span>   <span data-index="106" data-begin="62.029" data-dur="0.47" tabindex="0">public</span>   <span data-index="107" data-begin="62.559" data-dur="0.12" tabindex="0">I</span>   <span data-index="108" data-begin="62.679" data-dur="0.62" tabindex="0">consider</span>   <span data-index="109" data-begin="63.33" data-dur="0.269" tabindex="0">as</span>   <span data-index="110" data-begin="63.599" data-dur="0.099" tabindex="0">the</span>   <span data-index="111" data-begin="63.699" data-dur="0.56" tabindex="0">greatest</span>   <span data-index="112" data-begin="64.259" data-dur="0.47" tabindex="0">reward</span>   <span data-index="113" data-begin="64.729" data-dur="0.089" tabindex="0">of</span>   <span data-index="114" data-begin="64.849" data-dur="0.149" tabindex="0">my</span>   <span data-index="115" data-begin="65.0" data-dur="0.669" tabindex="0">labours</span>   ;  <span data-index="116" data-begin="66.189" data-dur="0.269" tabindex="0">but</span>   <span data-index="117" data-begin="66.459" data-dur="0.199" tabindex="0">am</span>   <span data-index="118" data-begin="66.66" data-dur="0.56" tabindex="0">determined</span>   <span data-index="119" data-begin="67.219" data-dur="0.149" tabindex="0">to</span>   <span data-index="120" data-begin="67.369" data-dur="0.429" tabindex="0">regard</span>   <span data-index="121" data-begin="67.799" data-dur="0.199" tabindex="0">its</span>   <span data-index="122" data-begin="68.0" data-dur="0.539" tabindex="0">judgment</span>   ,  <span data-index="123" data-begin="68.979" data-dur="0.57" tabindex="0">whatever</span>   <span data-index="124" data-begin="69.549" data-dur="0.099" tabindex="0">it</span>   <span data-index="125" data-begin="69.65" data-dur="0.359" tabindex="0">be</span>   ,  <span data-index="126" data-begin="70.57" data-dur="0.24" tabindex="0">as</span>   <span data-index="127" data-begin="70.809" data-dur="0.17" tabindex="0">my</span>   <span data-index="128" data-begin="71.009" data-dur="0.329" tabindex="0">best</span>   <span data-index="129" data-begin="71.339" data-dur="0.61" tabindex="0">instruction</span>   .</p>
            </div>

            <footer class="credits">
                <div>阅读外语经典，了解世界文化，复兴中华文明</div>
                <div>听语族外语软件工作室出品 湖南长沙</div>
            </footer>
        </article>

        <footer class="credits">
            Support by
            <a rel="author" href="mailto:knightmade@qq.com">meng gang</a>,
            Code licensed <a href="http://www.opensource.org/licenses/MIT" rel="license">MIT</a>/<a href="http://www.gnu.org/licenses/gpl.html" rel="license">GPL</a>.
        </footer>

<script type="text/javascript">

    /**
     * HTML5 Audio Read-Along
     * @author Weston Ruter, X-Team
     * @license MIT/GPL
     * https://github.com/westonruter/html5-audio-read-along
     */
    var ReadAlong = {
        text_element: null,
        audio_element: null,
        autofocus_current_word: true,

        words: [],

        init: function (args) {
            var name;
            for (name in args) {
                this[name] = args[name];
            }
            this.generateWordList();
            this.addEventListeners();
            this.selectCurrentWord();
        },

        /**
         * Build an index of all of the words that can be read along with their begin,
         * and end times, and the DOM element representing the word.
         */
        generateWordList: function () {
            var word_els = this.text_element.querySelectorAll('[data-begin]');
            this.words = Array.prototype.map.call(word_els, function (word_el, index) {
                var word = {
                    'begin': parseFloat(word_el.dataset.begin),
                    'dur': parseFloat(word_el.dataset.dur),
                    'element': word_el
                };
                word_el.tabIndex = 0; // to make it focusable/interactive
                word.index = index;
                word.end = word.begin + word.dur;
                word_el.dataset.index = word.index;
                return word;
            });
        },

        /**
         * From the audio's currentTime, find the word that is currently being played
         * @todo this would better be implemented as a binary search
         */
        getCurrentWord: function () {
            var i;
            var len;
            var is_current_word;
            var word = null;
            for (i = 0, len = this.words.length; i < len; i += 1) {
                is_current_word = (
                    (
                        this.audio_element.currentTime >= this.words[i].begin
                        &&
                        this.audio_element.currentTime < this.words[i].end
                    )
                    ||
                    (this.audio_element.currentTime < this.words[i].begin)
                );
                if (is_current_word) {
                    word = this.words[i];
                    break;
                }
            }

            if (!word) {
                throw Error('Unable to find current word and we should always be able to.');
            }
            return word;
        },

        _current_end_select_timeout_id: null,
        _current_next_select_timeout_id: null,

        /**
         * Select the current word and set timeout to select the next one if playing
         */
        selectCurrentWord: function() {
            var that = this;
            var current_word = this.getCurrentWord();
            var is_playing = !this.audio_element.paused;

            if (!current_word.element.classList.contains('speaking')) {
                this.removeWordSelection();
                current_word.element.classList.add('speaking');
                if (this.autofocus_current_word) {
                    current_word.element.focus();
                }
            }

            /**
             * The timeupdate Media event does not fire repeatedly enough to be
             * able to rely on for updating the selected word (it hovers around
             * 250ms resolution), so we add a setTimeout with the exact duration
             * of the word.
             */
            if (is_playing) {
                // Remove word selection when the word ceases to be spoken
                var seconds_until_this_word_ends = current_word.end - this.audio_element.currentTime; // Note: 'word' not 'world'! ;-)
                if (typeof this.audio_element === 'number' && !isNaN(this.audio_element)) {
                    seconds_until_this_word_ends *= 1.0/this.audio_element.playbackRate;
                }
                clearTimeout(this._current_end_select_timeout_id);
                this._current_end_select_timeout_id = setTimeout(
                    function () {
                        if (!that.audio_element.paused) { // we always want to have a word selected while paused
                            current_word.element.classList.remove('speaking');
                        }
                    },
                    Math.max(seconds_until_this_word_ends * 1000, 0)
                );

                // Automatically trigger selectCurrentWord when the next word begins
                var next_word = this.words[current_word.index + 1];
                if (next_word) {
                    var seconds_until_next_word_begins = next_word.begin - this.audio_element.currentTime;

                    var orig_seconds_until_next_word_begins = seconds_until_next_word_begins; // temp
                    if (typeof this.audio_element === 'number' && !isNaN(this.audio_element)) {
                        seconds_until_next_word_begins *= 1.0/this.audio_element.playbackRate;
                    }
                    clearTimeout(this._current_next_select_timeout_id);
                    this._current_next_select_timeout_id = setTimeout(
                        function () {
                            that.selectCurrentWord();
                        },
                        Math.max(seconds_until_next_word_begins * 1000, 0)
                    );
                }
            }

        },

        removeWordSelection: function() {
            // There should only be one element with .speaking, but selecting all for good measure
            var spoken_word_els = this.text_element.querySelectorAll('span[data-begin].speaking');
            Array.prototype.forEach.call(spoken_word_els, function (spoken_word_el) {
                spoken_word_el.classList.remove('speaking');
            });
        },


        addEventListeners: function () {
            var that = this;

            /**
             * Select next word (at that.audio_element.currentTime) when playing begins
             */
            that.audio_element.addEventListener('play', function (e) {
                that.selectCurrentWord();
                that.text_element.classList.add('speaking');
            }, false);

            /**
             * Abandon seeking the next word because we're paused
             */
            that.audio_element.addEventListener('pause', function (e) {
                that.selectCurrentWord(); // We always want a word to be selected
                that.text_element.classList.remove('speaking');
            }, false);

            /**
             * Seek by selecting a word (event delegation)
             */
            function on_select_word_el(e) {
                if (!e.target.dataset.begin) {
                    return;
                }
                e.preventDefault();

                var i = e.target.dataset.index;
                that.audio_element.currentTime = that.words[i].begin + 0.01; //Note: times apparently cannot be exactly set and sometimes select too early
                that.selectCurrentWord();
            }
            that.text_element.addEventListener('click', on_select_word_el, false);
            that.text_element.addEventListener('keypress', function (e) {
                if ( (e.charCode || e.keyCode) === 13 /*Enter*/) {
                    on_select_word_el.call(this, e);
                }
            }, false);

            /**
             * Spacebar toggles playback
             */
            document.addEventListener('keypress', function (e) {
                if ( (e.charCode || e.keyCode) === 32 /*Space*/) {
                    e.preventDefault();
                    if (that.audio_element.paused) {
                        that.audio_element.play();
                    }
                    else {
                        that.audio_element.pause();
                    }
                }
            }, false);

            /**
             * First click handler sets currentTime to the word, and second click
             * here then causes it to play.
             * @todo Should it stop playing once the duration is over?
             */
            that.text_element.addEventListener('dblclick', function (e) {
                e.preventDefault();
                that.audio_element.play();
            }, false);

            /**
             * Select a word when seeking
             */
            that.audio_element.addEventListener('seeked', function (e) {
                that.selectCurrentWord();

                /**
                 * Address probem with Chrome where sometimes it seems to get stuck upon seeked:
                 * http://code.google.com/p/chromium/issues/detail?id=99749
                 */
                var audio_element = this;
                if (!audio_element.paused) {
                    var previousTime = audio_element.currentTime;
                    setTimeout(function () {
                        if (!audio_element.paused && previousTime === audio_element.currentTime) {
                            audio_element.currentTime += 0.01; // Attempt to unstick
                        }
                    }, 500);
                }
            }, false);

            /**
             * Select a word when seeking
             */
            that.audio_element.addEventListener('ratechange', function (e) {
                that.selectCurrentWord();
            }, false);
        }
    };

    /*global ReadAlong */
    window.addEventListener('load', function (e) {
        try {
            var args = {
                text_element: document.getElementById('passage-text'),
                audio_element: document.getElementById('passage-audio'),
                autofocus_current_word: document.getElementById('autofocus-current-word').checked
            };

            if (!args.audio_element.canPlayType) {
                // No error messaging is needed because error message appears in <audio> fallback
                throw new Error('HTML5 Audio not supported');
            }
            if (args.audio_element.networkState === args.audio_element.NETWORK_NO_SOURCE) {
                document.querySelector('.passage-audio-unavailable').hidden = false;
                throw new Error('Cannot play any of the available sources');
            }

            var supports_playback_rate = (function (audio) {
                if (typeof audio.playbackRate !== 'number' || isNaN(audio.playbackRate)) {
                    return false;
                }

                // For Opera, since it doesn't currently support playbackRate and yet
                // has it defined as 1.0, we can detect Opera support by changing
                // the playbackRate and see if the change sticks.
                var original_playback_rate = audio.playbackRate;
                audio.playbackRate += 1.0;
                var is_playback_rate_changed = (original_playback_rate !== audio.playbackRate);
                audio.playbackRate = original_playback_rate;
                return is_playback_rate_changed;
            }(args.audio_element));

            if (supports_playback_rate) {
                var rate_range_element = document.getElementById('playback-rate');
                rate_range_element.disabled = false;
                rate_range_element.addEventListener('change', function (e) {
                    args.audio_element.playbackRate = this.valueAsNumber;
                }, false);
            }
            else {
                document.querySelector('.playback-rate-unavailable').hidden = false;
            }

            ReadAlong.init(args);

            document.getElementById('autofocus-current-word').addEventListener('change', function (e) {
                ReadAlong.autofocus_current_word = this.checked;
            }, false);

            document.querySelector('.passage-audio').hidden = false;
            if (supports_playback_rate) {
                document.querySelector('.playback-rate').hidden = false;
            }
            document.querySelector('.autofocus-current-word').hidden = false;
        } catch (err) {
            console.error(err);
        }
        document.body.classList.add('initialized');
        document.querySelector('.loading').hidden = true;

        var ElementClass = {
            dict: {},

            create: function(class_name) {
                var tmp = class_name.split(/[\s\t\r\n]+/);
                var dict = {};
                for (var i in tmp) {
                    var x = tmp[i];
                    if (x && !(x in dict)) {
                        dict[x] = true;
                    }
                }
                this.dict = dict;
                return this;
            },

            hasClass: function(class_name) {
                return class_name in this.dict;
            },

            addClass: function(class_name) {
                this.dict[class_name] = true;
            },

            removeClass: function(class_name) {
                delete this.dict[class_name];
            },

            toString: function() {
                var tmp = [];
                for (var x in this.dict) {
                    tmp.push(x);
                }
                return tmp.join(' ');
            },
        };

        window.addEventListener('scroll', function(e) {
            var bodyClass = ElementClass.create(document.querySelector('body').className);
            if (window.scrollY >= 100) {
                bodyClass.addClass('sticky-header');
            } else {
                bodyClass.removeClass('sticky-header');
            }
            document.querySelector('body').className = bodyClass.toString();
        }, false);

    }, false);


</script>


    </body>
</html>
